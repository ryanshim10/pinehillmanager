<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>제조 AI/DX 용어집</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>제조 AI/DX 용어집</h1>
      <p class="sub">HYUNDAI WIA CI 톤(Blue/Red) 기반 UI · 검색/필터/업로드/엑셀</p>
    </header>

    <section class="search">
      <input id="q" placeholder="예: RAG, OEE, MES, 예지보전" autocomplete="off" />

      <select id="category">
        <option value="">전체 카테고리</option>
      </select>

      <button id="btnSearch">검색</button>
      <button id="btnExport" class="secondary">엑셀 다운로드</button>
      <button id="btnDraft" class="secondary" {{ 'disabled' if not llm_enabled else '' }}>
        없음 → 초안 생성
      </button>

      {% if llm_enabled %}
      <label class="toggle">
        <input type="checkbox" id="autoDraft" />
        검색 결과 없으면 자동으로 초안 생성
      </label>
      {% else %}
      <div class="hint">LLM 초안 생성은 현재 비활성화(LLM_MODE=off) 상태입니다.</div>
      {% endif %}
    </section>

    <section class="upload">
      <div class="uploadRow">
        <input id="uploadFile" type="file" accept=".xlsx" />
        <button id="btnUpload" class="secondary">일괄 업로드(xlsx)</button>
        {% if llm_enabled %}
        <label class="toggle">
          <input type="checkbox" id="fillMissing" checked />
          빈 칸은 LLM이 채우기
        </label>
        {% else %}
        <label class="toggle">
          <input type="checkbox" id="fillMissing" disabled />
          빈 칸 자동 채우기(LLM 비활성)
        </label>
        {% endif %}
      </div>
      <div class="hint">엑셀 1행은 헤더. 최소 "용어(KR)" 컬럼이 필요해.</div>
    </section>

    <section class="results">
      <div id="results"></div>
    </section>

    <section class="detail">
      <div id="detail"></div>
    </section>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function loadCategories(){
  const res = await fetch('/api/categories');
  const data = await res.json();
  const sel = $('category');
  (data.categories||[]).forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    sel.appendChild(opt);
  });
}

async function search(){
  const q = $('q').value.trim();
  const category = $('category').value;
  if(!q && !category){ $('results').innerHTML = '<div class="muted">검색어 또는 카테고리를 선택해줘.</div>'; return; }
  $('detail').innerHTML = '';
  const res = await fetch('/api/search?q='+encodeURIComponent(q)+'&category='+encodeURIComponent(category));
  const data = await res.json();
  if(!data.results || data.results.length===0){
    $('results').innerHTML = '<div class="muted">일치 항목 없음.</div>';
    // optional auto-draft when enabled
    const auto = $('autoDraft');
    if(auto && auto.checked){
      await draft();
      return;
    }
    $('results').innerHTML += '<div class="muted">("없음 → 초안 생성" 가능)</div>';
    return;
  }
  $('results').innerHTML = data.results.map(r=>
    `<div class="card" onclick="loadTerm('${escapeHtml(r.kr)}')">
      <div class="title">${escapeHtml(r.kr)} <span class="tag">${escapeHtml(r.en||'')}</span></div>
      <div class="meta">${escapeHtml(r.category||'')}</div>
      <div class="desc">${escapeHtml(r.oneLine||'')}</div>
    </div>`
  ).join('');
}

async function loadTerm(term){
  const res = await fetch('/api/term?term='+encodeURIComponent(term));
  if(!res.ok){ $('detail').innerHTML = '<div class="muted">상세를 불러오지 못했어.</div>'; return; }
  const t = await res.json();
  renderDetail(t);
}

function renderDetail(t){
  const kpi = (t.kpi||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const conf = (t.confusions||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(' ');
  const ask = (t.ask||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('');

  const sourceTag = t.createdBy || t.source || 'USER';

  $('detail').innerHTML = `
    <div class="panel">
      <div class="panelTitle">${escapeHtml(t.kr)} <span class="tag">${escapeHtml(t.en||'')}</span> <span class="tag">${escapeHtml(sourceTag)}</span></div>

      <div class="row"><b>분류</b> ${escapeHtml(t.category||'')}</div>
      <div class="row"><b>한줄 정의</b><div>${escapeHtml(t.oneLine||'')}</div></div>
      <div class="row"><b>예시</b><div>${escapeHtml(t.example||'')}</div></div>
      <div class="row"><b>KPI</b><div>${kpi || '<span class="muted">-</span>'}</div></div>
      <div class="row"><b>혼동 용어</b><div>${conf || '<span class="muted">-</span>'}</div></div>
      <div class="row"><b>현업 질문</b><ul>${ask || '<li class="muted">-</li>'}</ul></div>

      <div class="actions">
        <button class="secondary" onclick="toggleEdit(true)">수정</button>
      </div>

      <div id="editBox" class="edit" style="display:none">
        <div class="editGrid">
          <label>용어(KR) <input id="e_kr" /></label>
          <label>약어/EN <input id="e_en" /></label>
          <label>분류 <input id="e_category" placeholder="전략/데이터/AI/자동화/운영/보안/성과" /></label>
          <label>한줄 정의 <textarea id="e_oneLine" rows="2"></textarea></label>
          <label>예시 <textarea id="e_example" rows="2"></textarea></label>
          <label>KPI (쉼표/줄바꿈) <textarea id="e_kpi" rows="2"></textarea></label>
          <label>혼동 용어 (쉼표/줄바꿈) <textarea id="e_confusions" rows="2"></textarea></label>
          <label>현업 질문 (줄바꿈) <textarea id="e_ask" rows="3"></textarea></label>
        </div>
        <div class="actions">
          <button onclick="saveEdit()">저장</button>
          <button class="secondary" onclick="toggleEdit(false)">취소</button>
        </div>
      </div>
    </div>
  `;

  // fill form
  $('e_kr').value = t.kr || '';
  $('e_en').value = t.en || '';
  $('e_category').value = t.category || '';
  $('e_oneLine').value = t.oneLine || '';
  $('e_example').value = t.example || '';
  $('e_kpi').value = (t.kpi||[]).join(', ');
  $('e_confusions').value = (t.confusions||[]).join(', ');
  $('e_ask').value = (t.ask||[]).join('\n');
}

function toggleEdit(on){
  const box = $('editBox');
  if(!box) return;
  box.style.display = on ? 'block' : 'none';
}

function splitList(s){
  if(!s) return [];
  return s.split(/\n|,/).map(x=>x.trim()).filter(Boolean);
}

async function saveEdit(){
  const payload = {
    kr: $('e_kr').value.trim(),
    en: $('e_en').value.trim(),
    category: $('e_category').value.trim(),
    oneLine: $('e_oneLine').value.trim(),
    example: $('e_example').value.trim(),
    kpi: splitList($('e_kpi').value),
    confusions: splitList($('e_confusions').value),
    ask: ($('e_ask').value||'').split(/\n/).map(x=>x.trim()).filter(Boolean),
    createdBy: 'USER',
  };

  $('detail').insertAdjacentHTML('beforeend', '<div class="muted" id="saveMsg">저장 중…</div>');
  const res = await fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  const msg = $('saveMsg');
  if(msg) msg.remove();

  if(!res.ok){
    $('results').innerHTML = '<div class="muted">저장 실패: '+escapeHtml(data.error||'')+'</div>';
    return;
  }
  toggleEdit(false);
  renderDetail(data.item);
}

async function draft(){
  const term = $('q').value.trim();
  if(!term){ return; }
  $('detail').innerHTML = '<div class="muted">초안 생성 중…</div>';
  const form = new FormData();
  form.append('term', term);
  const res = await fetch('/api/draft', { method:'POST', body: form });
  const data = await res.json();
  if(!res.ok){ $('detail').innerHTML = '<div class="muted">초안 생성 실패: '+escapeHtml(data.error||'')+'</div>'; return; }
  renderDetail(data.item);
}

async function uploadXlsx(){
  const f = $('uploadFile').files && $('uploadFile').files[0];
  if(!f){ $('results').innerHTML = '<div class="muted">업로드할 .xlsx 파일을 선택해줘.</div>'; return; }

  $('results').innerHTML = '<div class="muted">업로드/처리 중…</div>';
  const form = new FormData();
  form.append('file', f);
  const fill = $('fillMissing');
  form.append('fillMissing', (fill && fill.checked) ? 'on' : 'off');

  const res = await fetch('/api/upload.xlsx', { method:'POST', body: form });
  const data = await res.json();
  if(!res.ok){
    $('results').innerHTML = '<div class="muted">업로드 실패: '+escapeHtml(data.error||'')+'</div>';
    return;
  }

  const r = data.report || {};
  $('results').innerHTML = `
    <div class="panel">
      <div class="panelTitle">업로드 결과</div>
      <div class="row"><b>추가</b> ${r.added||0}</div>
      <div class="row"><b>업데이트</b> ${r.updated||0}</div>
      <div class="row"><b>LLM 채움</b> ${r.filledByLLM||0}</div>
      <div class="row"><b>스킵</b> ${r.skipped||0}</div>
      <div class="row"><b>총 용어수</b> ${data.count||0}</div>
    </div>
  `;
}

$('btnSearch').addEventListener('click', search);
$('btnExport').addEventListener('click', ()=>{ window.location.href = '/api/export.xlsx'; });
$('btnUpload').addEventListener('click', uploadXlsx);
$('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });
$('btnDraft').addEventListener('click', draft);

loadCategories();
window.loadTerm = loadTerm;
</script>
</body>
</html>
